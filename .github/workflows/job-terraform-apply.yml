name: job-terraform-apply

on: workflow_call

jobs:
  terraform-apply:
    timeout-minutes: 30

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3.6.0

      - uses: hashicorp/setup-terraform@v2.0.3
        with:
          cli_config_credentials_token: ${{ secrets.TF_TOKEN }}

      # cache terraform plugins
      - uses: actions/cache@v3.3.1
        id: terraform-cache
        with:
          key: terraform-cache-${{ hashFiles('.terraform.lock.hcl') }}
          path: .terraform

      # install plugins
      - run: terraform init

      - id: terraform-cloud
        uses: ahmadnassri/action-terraform-cloud-api@v1.0.2
        with:
          token: ${{ secrets.TF_TOKEN }}
          organization: foobar
          workspace: my-project

      - if: ${{ steps.terraform-cloud.outputs.workspace_locked == 'true' }}
        run: |
          echo "::error::workspace is locked"
          exit 1

      # execute plan
      - run: terraform apply -auto-approve
        if: ${{ steps.terraform-cloud.outputs.workspace_locked == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}

          TF_VAR_TOKEN_CLOUDFLARE: ${{ secrets.CLOUDFLARE_TOKEN }}
          TF_VAR_TOKEN_DOCKERHUB: ${{ secrets.DOCKER_TOKEN }}
          TF_VAR_TOKEN_GITHUB: ${{ secrets.GH_TOKEN }}
          TF_VAR_TOKEN_NPM: ${{ secrets.NPM_TOKEN }}
          TF_VAR_TOKEN_TERRAFORM: ${{ secrets.TF_TOKEN }}
          TF_VAR_TOKEN_ROTATION: ${{ secrets.TOKEN_ROTATION }}
