name: docker-publis

on:
  workflow_call:
    secrets:
      password:
        description: password to login to registry
        required: false

    inputs:
      name:
        type: string
        description: image name to publish
        required: true

      dry-run:
        type: boolean
        description: dry run
        default: false
        required: false

      registry:
        type: string
        default: ghcr.io
        description: registry to publish to
        required: false

      username:
        type: string
        description: username to login to registry
        default: ${{ github.repository_owner }}
        required: false

      platforms:
        type: string
        description: platform to publish
        default: linux/amd64,linux/arm64,linux/arm/v
        required: false

      version:
        type: string
        description: release to publish
        required: false

      alias:
        type: string
        description: release alias to publish
        required: false

jobs:
  docker-build-test:
    timeout-minutes: 10

    runs-on: ubuntu-latest

    if: ${{ inputs.dry-run == true }}

    steps:
      - uses: actions/checkout@v3.5.3
      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2

      # test build
      - uses: docker/build-push-action@v4
        with:
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ inputs.registry }}/${{ inputs.username }}/${{ inputs.name }}:test

      - name: clear-test-image
        run: docker run --rm ${{ inputs.registry }}/${{ inputs.username }}/${{ inputs.name }}:test

  docker-build-push:
    timeout-minutes: 10

    name: ${{ format('publish to {0}', inputs.registry) || 'publish-step' }}

    runs-on: ubuntu-latest

    if: ${{ inputs.dry-run == false }}

    steps:
      - uses: actions/checkout@v3.5.3
      - uses: docker/setup-qemu-action@v2
      - uses: docker/setup-buildx-action@v2

      # login to registry
      - uses: docker/login-action@v2
        with:
          registry: ${{ inputs.registry }}
          username: ${{ inputs.username }}
          password: ${{ secrets.password }}

      # publish
      - uses: docker/build-push-action@v4
        with:
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: ${{ inputs.platforms }}
          tags: |
            ${{ inputs.registry }}/${{ inputs.username }}/${{ inputs.name }}:latest
            ${{ inputs.registry }}/${{ inputs.username }}/${{ inputs.name }}:${{ inputs.alias }}
            ${{ inputs.registry }}/${{ inputs.username }}/${{ inputs.name }}:${{ inputs.version }}
          labels: |
            org.opencontainers.image.title=${{ inputs.name }}
            org.opencontainers.image.url=${{ github.event.repository.html_url }}
            org.opencontainers.image.version=${{ inputs.version }}
            org.opencontainers.image.source=${{ github.event.repository.html_url }}
            org.opencontainers.image.revision=${{ github.sha }}
